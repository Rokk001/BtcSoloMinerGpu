name: Build and Publish Docker Image

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            tag:
                description: "Tag to publish (e.g., v2.0.2)"
                required: false

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
            # Need admin permissions to change package visibility
            id-token: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Determine tag
              id: vars
              run: |
                  if [ -n "${{ github.event.inputs.tag }}" ]; then
                    echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
                  else
                    echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
                  fi
                  echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
                  echo "image_latest=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT

            - name: Extract metadata (for tags)
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=semver,pattern={{major}}
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Install GitHub CLI
              run: |
                  type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
                  && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
                  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
                  && sudo apt update \
                  && sudo apt install gh -y

            - name: Make package public
              run: |
                  # Get the repository name in lowercase (GHCR uses lowercase)
                  IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')

                  echo "Attempting to make package public: ${IMAGE_NAME_LOWER}"

                  # Wait a moment for the package to be fully created
                  sleep 5

                  # Try to set package visibility to public using GitHub API
                  # First try with user endpoint
                  gh api \
                    -X PATCH \
                    /user/packages/container/${IMAGE_NAME_LOWER}/ \
                    -f visibility=public \
                    || \
                  # If that fails, try with org endpoint
                  gh api \
                    -X PATCH \
                    /orgs/${{ github.repository_owner }}/packages/container/${IMAGE_NAME_LOWER}/ \
                    -f visibility=public \
                    || echo "Warning: Could not automatically set package to public. Please set it manually:"
                  echo "1. Go to: https://github.com/${{ github.repository_owner }}?tab=packages"
                  echo "2. Find the 'satoshirig' package"
                  echo "3. Click on it, then go to Package settings"
                  echo "4. Scroll down to 'Danger Zone' and click 'Change visibility'"
                  echo "5. Select 'Public' and confirm"
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
